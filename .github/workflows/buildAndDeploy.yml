name: Build and Deploy Docker Images

# Triggered, when new Version-Tag is created
on:
  push:
    tags:
      - 'v*'

jobs:
  #--------------------------------------------------BUILD Section
  build:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest

    steps:
    # Check out codee and login to Docker Hub
    - name: Checkout Code
      uses: actions/checkout@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # github.ref_name
    # When Workflow is triggered through Version-Tag -> the ref_name should be something like v1.0.0

    # Backend - Authentication
    - name: Build Authentication Backend (Gradle)
      run: |
        cd flou/authentication
        ./gradlew dependencies
        ./gradlew bootJar
        cd ../..
    - name: Build and Push Authentication Image
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/authentication:${{ github.ref_name }} flou/authentication/
        docker push ${{ secrets.DOCKER_USERNAME }}/authentication:${{ github.ref_name }}

    # Backend - ToDo
    - name: Build ToDo Backend (Gradle)
      run: |
        cd flou/todo
        ./gradlew dependencies
        ./gradlew bootJar
        cd ../..
    - name: Build and Push ToDo Image
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/todo:${{ github.ref_name }} flou/todo/
        docker push ${{ secrets.DOCKER_USERNAME }}/todo:${{ github.ref_name }}

  # Frontend
    - name: Build Frontend (npm)
      run: |
        cd flou/frontend
        npm clean-install
        npm run build
        cd ../..
    - name: Build and Push Frontend Image
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/frontend:${{ github.ref_name }} flou/frontend/
        docker push ${{ secrets.DOCKER_USERNAME }}/frontend:${{ github.ref_name }}

  #--------------------------------------------------DEPLOY Section

  deploy:
    name: Deploy to GCP
    runs-on: ubuntu-latest
    needs: build

    # Setup everything for the Google Cloud and login
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}

      #NEW
      - name: Authenticate to GCP
        run: gcloud auth activate-service-account --key-file="${{ secrets.GCP_SA_KEY }}"

      - name: Install GKE Auth Plugin
        run: gcloud components install gke-gcloud-auth-plugin

      - name: Configure Kubernetes Context
        run: gcloud container clusters get-credentials flou-cluster-1 --zone europe-west8-a --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Verify Kubernetes Context
        run: kubectl config current-context

        #NEW

      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f flou/authentication/k8s/deployment.yaml
          kubectl apply -f flou/authentication/k8s/service.yaml
          kubectl apply -f flou/todo/k8s/deployment.yaml
          kubectl apply -f flou/todo/k8s/service.yaml
          kubectl apply -f flou/frontend/k8s/deployment.yaml
          kubectl apply -f flou/frontend/k8s/service.yaml
